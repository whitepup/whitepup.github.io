<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Record Store</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; } body { font-family: Arial, sans-serif; background: #fff; color: #111; display: flex; flex-direction: column; }
    .header { position: sticky; top: 0; z-index: 50; background: #fff; border-bottom: 1px solid #e6e6e6; padding: 12px 14px; }
    .top { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .title { font-size: 20px; font-weight: 800; margin-right: 8px; }
    .sub { font-size: 12px; color: #666; margin-top: 6px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; width: 100%; margin-top: 10px; }
    input, select { border: 1px solid #d6d6d6; border-radius: 10px; padding: 8px 10px; background: #fff; }
    input { flex: 1; min-width: 220px; }
    .btn { border: 1px solid #d6d6d6; background: #fff; padding: 8px 10px; border-radius: 10px; cursor: pointer; }
    .btn:disabled { opacity: .45; cursor: not-allowed; }
    .cartbtn { margin-left: auto; white-space: nowrap; }
    .content { flex: 1 1 auto; min-height: 0; overflow-y: auto; padding: 14px; }
    .grid { display: grid; grid-template-columns: minmax(0, 1fr); gap: 6px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 6px 8px; display: flex; align-items: center; gap: 8px; }
    .cover { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; background: #f5f5f5; flex: 0 0 auto; }
    .meta { flex: 1 1 auto; min-width: 0; }
    .artist { font-weight: 800; }
    .title2 { margin-top: 2px; }
    .line { margin-top: 6px; font-size: 12px; color: #333; }
    .muted { color: #666; }
    .row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 4px; }
    .price { font-weight: 900; }
    .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #ddd; background: #fafafa; }
    .badge.pending { background: #fff4b8; border-color: #e5d27a; }
    .badge.sold { background: #eee; }
    .badge.hold { background: #e6f3ff; }
    .small { font-size: 12px; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; padding: 18px; }
    .modal.open { display: flex; }
    .modalbox { width: min(720px, 96vw); max-height: 90vh; overflow: auto; background: #fff; border-radius: 16px; padding: 14px; }
    .modalhead { display: flex; align-items: center; gap: 10px; }
    .modalhead h2 { margin: 0; font-size: 18px; }
    .close { margin-left: auto; }
    textarea { width: 100%; min-height: 220px; border-radius: 12px; border: 1px solid #d6d6d6; padding: 10px; }
    .nowrap { white-space: nowrap; }
    .qtypill{font-size:12px;padding:3px 7px;border-radius:999px;border:1px solid #ddd;background:#fff}
  
    .intro { margin: 10px 0 16px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background: rgba(0,0,0,0.02); }
    .intro p { margin: 6px 0; }
    .cartlist { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
    .cartrow { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid #ddd; border-radius: 10px; }
    .cartrow .meta { flex: 1; }
    .cartrow .qty { font-variant-numeric: tabular-nums; min-width: 64px; text-align: right; }
    .cartrow button { padding: 6px 10px; }

  /* V11 modal fixes */
#modal { z-index: 99999 !important; }
#modal .modal-card { max-width: min(980px, calc(100vw - 24px)); width: min(980px, calc(100vw - 24px)); overflow-x: hidden; }
#modal .modal-body { overflow-x: hidden; }
#cartList { overflow-x: hidden; }
.cartrow { flex-wrap: wrap; overflow-x: hidden; }
.cartrow .meta { min-width: 0; overflow-wrap: anywhere; word-break: break-word; }
#cartText { overflow-x: hidden; white-space: pre-wrap; }

  
    .pricecol { min-width: 56px; text-align: center; font-weight: 900; font-size: 13px; }
    .controlsRow { display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 40px; }
    .controlsRow .btn { padding: 3px 5px; font-size: 11px; }
    .controlsRow .small { font-size: 11px; }
</style>
</head>
<body>
  <div class="header">
    <div class="controls">
      <button id="helpOpen" class="btn">Help / About</button>
      <button id="cartOpen" class="btn cartbtn">Cart (0)</button>
      <input id="q" placeholder="Search artist or title..." />
      <select id="artist"><option value="">All artists</option></select>
      <select id="genre"><option value="">All genres</option></select>
      <select id="decade"><option value="">All decades</option></select>
      <button id="clear" class="btn">Clear</button>
    </div>
  </div>

  <div class="content">
    <div id="status" class="muted small">Loading…</div>
    <div id="grid" class="grid" style="margin-top:10px;"></div>
  </div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modalbox">
      <div class="modalhead">
        <h2>Your cart</h2>
        <button id="modalClose" class="btn close">Close</button>
      </div>
      <div class="muted small" style="margin-top:6px;">Copy/paste this into a message to me.</div>
      <textarea id="cartText" readonly></textarea>
      <div id="cartList" class="cartlist"></div>
      <div class="row">
        <button id="clearCartBtn" class="btn">Clear cart</button>
        <button id="copyBtn" class="btn">Copy</button>
<div id="cartMeta" class="muted small"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const state = { items: [], filtered: [], cart: {} };
  const CART_KEY = "store_cart_v1";

  function loadCart(){ try{ state.cart = JSON.parse(localStorage.getItem(CART_KEY)||"{}")||{}; }catch{ state.cart={}; } }
  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(state.cart)); }

  function money(x){
    const n = Number(String(x||"").replace(/[^0-9.]/g,""));
    return isFinite(n) && n>0 ? "$" + n.toFixed(0) : "";
  }

  function cartSummary(){
    const lines = [];
    const cartItems = [];
    let total = 0, count = 0;
    lines.push("Record order inquiry:");
    lines.push("");
    Object.keys(state.cart).sort().forEach(rid=>{
      const qty = state.cart[rid]||0;
      if(qty<=0) return;
      const it = state.items.find(x=>x.release_id===rid);
      if(!it) return;
      const p = Number(String(it.price||"").replace(/[^0-9.]/g,""));
      const linePrice = (isFinite(p)&&p>0) ? p*qty : 0;
      if(linePrice) total += linePrice;
      count += qty;
      lines.push(`${qty}x ${it.artist} — ${it.title} (${it.year || "?"}) [${rid}] ${money(it.price) || ""}`.trim());
      if(it.status && it.status!=="available") lines.push(`   Status: ${it.status}`);
      if(it.condition) lines.push(`   Condition: ${it.condition}`);
      if(it.notes) lines.push(`   Notes: ${it.notes}`);
      if(it.qty>1) lines.push(`   Copies/Variants in stock: ${it.qty}`);
    });
    lines.push("");
    lines.push(`Items: ${count}`);
    if(total>0) lines.push(`Total: $${total.toFixed(0)}`);
    lines.push("");
    lines.push("Name:");
    lines.push("Pickup or Shipping (zip):");
    lines.push("Payment preference:");
    return { text: lines.join("\n"), total, count };
  }

  
function renderCartList(cartItems){
  const el = $("cartList");
  if(!el) return;
  if(!cartItems || cartItems.length===0){
    el.innerHTML = `<div class="muted small">Cart is empty.</div>`;
    return;
  }
  el.innerHTML = cartItems.map(ci=>{
    const label = `${ci.artist} — ${ci.title} (${ci.year}) [${ci.rid}]`;
    return `
      <div class="cartrow">
        <div class="meta">${escapeHtml(label)}</div>
        <div class="qty">Qty: <b>${ci.qty}</b></div>
        <button class="btn" data-action="remove-one" data-rid="${ci.rid}">-1</button>
        <button class="btn" data-action="add-one" data-rid="${ci.rid}">+1</button>
        <button class="btn" data-action="remove-all" data-rid="${ci.rid}">Remove</button>
      </div>`;
  }).join("");

  el.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const rid = btn.getAttribute("data-rid");
      const act = btn.getAttribute("data-action");
      const cur = Number(state.cart[rid]||0);
      if(act==="remove-one"){
        const next = Math.max(0, cur-1);
        if(next===0) delete state.cart[rid]; else state.cart[rid]=next;
      }else if(act==="add-one"){
        state.cart[rid] = cur+1;
      }else if(act==="remove-all"){
        delete state.cart[rid];
      }
      saveCart(); updateCartButton(); openCart(); // re-render modal
    });
  });
}

function updateCartButton(){
    const {count, total} = cartSummary();
    $("cartOpen").textContent = total>0 ? `Cart (${count}) — $${total.toFixed(0)}` : `Cart (${count})`;
  }

  function badge(status){
    const s = (status||"available").toLowerCase();
    if(s==="pending") return `<span class="badge pending">Pending</span>`;
    if(s==="sold") return `<span class="badge sold">Sold</span>`;
    if(s==="hold") return `<span class="badge hold">Hold</span>`;
    return "";
  }

  const HIDE_PENDING = true;
  function isHiddenByStatus(it){
    const hide = HIDE_PENDING;
    if(!hide) return false;
    const s = (it.status||"available").toLowerCase();
    return (s==="pending" || s==="sold");
  }

  function applyFilters(){
    const q = ($("q").value||"").trim().toLowerCase();
    const a = $("artist").value;
    const g = $("genre").value;
    const d = $("decade").value;

    state.filtered = state.items.filter(it=>{
      if(isHiddenByStatus(it)) return false;
      if(q && !(it.search_blob||"").includes(q)) return false;
      if(a && it.artist !== a) return false;
      if(g && (it.genre||"Unknown") !== g) return false;
      if(d && (it.decade||"Unknown") !== d) return false;
      return true;
    });

    render();
  }

  function setFilterOptions(){
    const artists = [...new Set(state.items.map(x=>x.artist).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    const genres  = [...new Set(state.items.map(x=>x.genre||"Unknown"))].sort((a,b)=>a.localeCompare(b));
    const decades = [...new Set(state.items.map(x=>x.decade||"Unknown"))].sort((a,b)=>a.localeCompare(b));

    function fill(sel, label, arr){
      const cur = sel.value;
      sel.innerHTML = `<option value="">${label}</option>`;
      arr.forEach(v=>{
        const o = document.createElement("option");
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });
      if(arr.includes(cur)) sel.value = cur;
    }
    fill($("artist"), "All artists", artists);
    fill($("genre"), "All genres", genres);
    fill($("decade"), "All decades", decades);
  }

  function render(){
    $("status").textContent = `${state.filtered.length} shown / ${state.items.length} total`;
    const grid = $("grid");
    grid.innerHTML = "";
    state.filtered.forEach(it=>{
      const inCart = state.cart[it.release_id] ? 1 : 0;

      const card = document.createElement("div");
      card.className = "card";

      // Price on far left
      const priceCol = document.createElement("div");
      priceCol.className = "pricecol";
      const priceText = money(it.price);
      priceCol.textContent = priceText || "";

      // Vertical controls column next: -, +, ? buttons
      const controls = document.createElement("div");
      controls.className = "controlsRow";

      const minus = document.createElement("button");
      minus.className = "btn";
      minus.textContent = "-";
      minus.disabled = inCart <= 0;
      minus.onclick = ()=>{
        if(!state.cart[it.release_id]) return;
        delete state.cart[it.release_id];
        saveCart(); updateCartButton(); render();
      };

      const plus = document.createElement("button");
      plus.className = "btn";
      plus.textContent = "+";
      plus.disabled = inCart > 0;
      plus.onclick = ()=>{
        if(state.cart[it.release_id]) return;
        state.cart[it.release_id] = 1;
        saveCart(); updateCartButton(); render();
      };

      const infoBtn = document.createElement("button");
      infoBtn.className = "btn";
      infoBtn.textContent = "?";
      infoBtn.onclick = ()=>openItemModal(it);

      controls.appendChild(minus);
      controls.appendChild(plus);
      controls.appendChild(infoBtn);

      // Image next
      const img = document.createElement("img");
      img.className = "cover";
      img.loading = "lazy";
      img.src = it.img || "";
      img.alt = `${it.artist || ""} — ${it.title || ""}`.trim();
      img.onerror = ()=>{ img.style.visibility="hidden"; };

      // Title + artist stacked vertically to the right
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <div class="artist">${escapeHtml(it.artist || "")}</div>
        <div class="title2">${escapeHtml(it.title || "")}</div>
      `;

      card.appendChild(priceCol);
      card.appendChild(controls);
      card.appendChild(img);
      card.appendChild(meta);

      grid.appendChild(card);
    });
    setFilterOptions();

  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }


  function openItemModal(it){
    const modal = $("itemModal");
    if(!modal) return;
    const titleEl = $("itemModalTitle");
    const bodyEl = $("itemModalBody");
    if(titleEl){
      titleEl.textContent = [it.artist || "", it.title || ""].filter(Boolean).join(" — ");
    }
    if(bodyEl){
      const year = it.year || "?";
      const label = it.label || "";
      const catno = it.catno || "";
      const genre = it.genre || "";
      bodyEl.innerHTML = `
        <p><b>Year:</b> ${escapeHtml(year)}</p>
        <p><b>Label:</b> ${escapeHtml(label)}</p>
        <p><b>Catalog #:</b> ${escapeHtml(catno)}</p>
        <p><b>Genre:</b> ${escapeHtml(genre)}</p>
      `;
    }
    modal.style.display = "flex";
    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
  }

  function closeItemModal(){
    const modal = $("itemModal");
    if(!modal) return;
    modal.style.display = "none";
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
  }

  function openCart(){
    const {text, total, count, cartItems} = cartSummary();
    $("cartText").value = text;
    $("cartMeta").textContent = total>0 ? `Items: ${count}  •  Total: $${total.toFixed(0)}` : `Items: ${count}`;
    
    renderCartList(cartItems);
$("modal").classList.add("open");
    $("modal").setAttribute("aria-hidden","false");
  }
  function closeCart(){
    $("modal").classList.remove("open");
    $("modal").setAttribute("aria-hidden","true");
  }

  function boot(){
    loadCart();
    updateCartButton();

    const itemClose = $("itemModalClose");
    if(itemClose){ itemClose.addEventListener("click", closeItemModal); }

$("q").addEventListener("input", ()=>applyFilters());
    $("artist").addEventListener("change", ()=>applyFilters());
    $("genre").addEventListener("change", ()=>applyFilters());
    $("decade").addEventListener("change", ()=>applyFilters());
    $("clear").addEventListener("click", ()=>{
      $("q").value="";
      $("artist").value="";
      $("genre").value="";
      $("decade").value="";
      applyFilters();
    });

    $("cartOpen").addEventListener("click", openCart);
    $("modalClose").addEventListener("click", closeCart);
    $("modal").addEventListener("click", (e)=>{ if(e.target===$("modal")) closeCart(); });

    $("copyBtn").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText($("cartText").value);
        $("copyBtn").textContent="Copied!";
      }catch(e){
        $("copyBtn").textContent="Copy failed";
      }
      setTimeout(()=>$("copyBtn").textContent="Copy", 1200);
    });

    $("clearCartBtn").addEventListener("click", ()=>{
      state.cart = {};
      saveCart(); updateCartButton(); openCart();
    });

    fetch("store_inventory.json", {cache:"no-store"})
      .then(r=>{
        if(!r.ok) throw new Error("HTTP "+r.status);
        return r.json();
      })
      .then(j=>{
        state.items = (j && j.items) ? j.items : [];
        state.filtered = state.items.slice();
        applyFilters();
      })
      .catch(err=>{
        $("status").textContent = "Failed to load store_inventory.json: " + err;
        console.error(err);
      });
  }
  boot();
})();
</script>


<div id="itemModal" class="modal" aria-hidden="true" style="display:none">
  <div class="modalbox">
    <div class="modalhead">
      <h2 id="itemModalTitle">Record details</h2>
      <button id="itemModalClose" class="btn close">Close</button>
    </div>
    <div class="modal-body small" id="itemModalBody" style="overflow-y:auto;max-height:70vh;"></div>
  </div>
</div>

<div id="helpModal" class="modal" aria-hidden="true" style="display:none">
  <div class="modalbox">
    <div class="modalhead">
      <h2>About This Catalog</h2>
      <button id="helpClose" class="btn close">Close</button>
    </div>
    <div class="modal-body small" style="overflow-y:auto;max-height:70vh;">
      <p><b>Collection focus:</b> Classic pop, jazz, easy listening, and vocal LPs.</p>
      <p><b>How to use:</b> Browse, use search and filters, then tap <b>Add to Cart</b> on anything you’re interested in.</p>
      <p>The cart builds a simple text list you can <b>copy/paste into a Facebook Marketplace message</b> when you’re ready to reach out.</p>
      <p>Status/condition may be uninspected unless noted. <b>Damaged records will be discounted.</b></p>
      <p>Feel free to message for detailed grading or questions — happy to help.</p>
    </div>
  </div>
</div>

<script>
(function(){
  const hm = document.getElementById("helpModal");
  const open = document.getElementById("helpOpen");
  const close = document.getElementById("helpClose");
  if(open){ open.onclick = ()=>{ hm.style.display='flex'; hm.classList.add('open'); hm.setAttribute('aria-hidden','false'); }; }
  if(close){ close.onclick = ()=>{ hm.style.display='none'; hm.classList.remove('open'); hm.setAttribute('aria-hidden','true'); }; }
})();
</script>

</body>
</html>
